# アーキテクチャ設計

## ドキュメント情報

| 項目           | 内容                                                                                                                                         |
| -------------- | -------------------------------------------------------------------------------------------------------------------------------------------- |
| プロジェクト名 | claude-dev-recorder                                                                                                                          |
| バージョン     | 1.0.0                                                                                                                                        |
| 作成日         | 2025-11-19                                                                                                                                   |
| 最終更新日     | 2025-11-19                                                                                                                                   |
| ステータス     | Draft                                                                                                                                        |
| 関連文書       | [コンポーネント設計](./02_components.md)、[データ設計](./03_data_design.md)、[デプロイメント・セキュリティ設計](./04_deployment_security.md) |

---

## 1. システム全体構成

### 1.1 アーキテクチャ概要図

```
┌─────────────────────────────────────────────────────────────┐
│                        Claude Code                          │
│  ┌────────────────────────────────────────────────────────┐ │
│  │              Claude AI (Sonnet/Opus)                   │ │
│  └────────────┬───────────────────────────┬────────────────┘ │
│               │                           │                  │
│               │ MCP Protocol              │ Hook Execution   │
│               ↓                           ↓                  │
│  ┌────────────────────────┐  ┌──────────────────────────┐  │
│  │   MCP Client           │  │   Hook Manager           │  │
│  │  (Claude Code内蔵)      │  │  (Claude Code内蔵)        │  │
│  └────────────┬───────────┘  └──────────┬───────────────┘  │
└───────────────┼──────────────────────────┼──────────────────┘
                │                          │
                │ stdio                    │ script execution
                ↓                          ↓
┌───────────────────────────────────────────────────────────────┐
│            claude-dev-recorder (npm package)                  │
├───────────────────────────────────────────────────────────────┤
│                                                               │
│  ┌──────────────────────┐      ┌──────────────────────────┐  │
│  │   MCP Server         │      │   Hook Scripts           │  │
│  │  (Node.js Process)   │      │  (Bash Scripts)          │  │
│  └──────────┬───────────┘      └──────────┬───────────────┘  │
│             │                             │                  │
│             ↓                             ↓                  │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │              Core Services Layer                      │   │
│  ├──────────────────────────────────────────────────────────┤   │
│  │  • DocumentManager: ドキュメント管理                   │   │
│  │  • DocumentMerger: ドキュメント統合                    │   │
│  │  • QualityManager: 品質管理・レビュー                  │   │
│  │  • VectorStore: ベクトル検索（オプション）             │   │
│  │  • Summarizer: 要約生成                              │   │
│  │  • MetadataExtractor: メタデータ抽出                  │   │
│  │  • AuditLogger: 監査ログ記録                          │   │
│  │  • FileWatcher: ファイルシステム監視                   │   │
│  │  • IntegrityChecker: データ整合性チェック             │   │
│  │  • SensitiveDataDetector: 機密情報検出                │   │
│  └──────────────────────┬───────────────────────────────┘   │
│                         │                                    │
│                         ↓                                    │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │              Data Layer                               │   │
│  ├──────────────────────────────────────────────────────────┤   │
│  │  • File System: Markdown文書                          │   │
│  │  • Vector DB: Vectra (埋め込みベクトル)                │   │
│  │  • Config Store: 設定ファイル                         │   │
│  └──────────────────────────────────────────────────────────┘   │
└───────────────────────────────────────────────────────────────┘
                         │
                         ↓
┌───────────────────────────────────────────────────────────────┐
│                  File System Storage                          │
├───────────────────────────────────────────────────────────────┤
│  .claude/                                                     │
│  ├── config.json           # Claude Code設定（MCP登録）       │
│  ├── recorder.config.json  # 本パッケージの設定               │
│  ├── hooks/                                                   │
│  │   ├── user-prompt-submit-hook    # プロンプト送信フック    │
│  │   └── after-tool-use-hook        # ツール使用後フック      │
│  └── docs/                                                    │
│      ├── 2025-11-19_abc123_auth-implementation.md            │
│      ├── 2025-11-19_def456_api-endpoint.md                   │
│      ├── .index/           # Vectraベクトルインデックス       │
│      ├── .archive/         # アーカイブされた古いドキュメント │
│      ├── .audit/           # 監査ログ                         │
│      │   └── audit.log     # 全操作の監査ログ（JSON形式）     │
│      └── .logs/            # エラーログ                       │
└───────────────────────────────────────────────────────────────┘
                         │
                         ↓
┌───────────────────────────────────────────────────────────────┐
│              External Services (Optional)                     │
├───────────────────────────────────────────────────────────────┤
│  Ollama (localhost:11434)                                     │
│  • llama3.2:3b モデル（要約生成用）                            │
│  • nomic-embed-text モデル（埋め込みベクトル生成用）            │
└───────────────────────────────────────────────────────────────┘
```

### 1.2 動作フロー

#### 1.2.1 初回セットアップフロー

```
[npm install claude-dev-recorder]
         ↓
┌─────────────────────────────────┐
│ postinstall script 実行         │
└─────────────────────────────────┘
         ↓
┌─────────────────────────────────┐
│ 1. 環境チェック                  │
│   - .claude/ の存在確認          │
│   - Node.js バージョン確認       │
└─────────────────────────────────┘
         ↓
┌─────────────────────────────────┐
│ 2. MCP設定の追加                │
│   - .claude/config.json読み込み  │
│   - mcpServers セクションに追加  │
│   - バックアップ作成             │
└─────────────────────────────────┘
         ↓
┌─────────────────────────────────┐
│ 3. フックスクリプト配置          │
│   - templates/からコピー         │
│   - 実行権限付与 (chmod +x)      │
└─────────────────────────────────┘
         ↓
┌─────────────────────────────────┐
│ 4. ディレクトリ初期化            │
│   - .claude/docs/ 作成           │
│   - .claude/docs/.index/ 作成    │
│   - .gitignore 更新（オプション） │
└─────────────────────────────────┘
         ↓
┌─────────────────────────────────┐
│ 5. 設定ファイル作成              │
│   - recorder.config.json生成     │
│   - デフォルト設定を書き込み      │
└─────────────────────────────────┘
         ↓
┌─────────────────────────────────┐
│ セットアップ完了メッセージ表示    │
│ "Claude Code を再起動してください" │
└─────────────────────────────────┘
```

**重要:** MCPサーバーはWebサーバーではありません。Claude Code起動時に自動的に起動されるNode.jsプロセスです。ユーザーが手動でサーバーを起動する必要はありません。

#### 1.2.2 Claude Code起動時の自動処理

```
[ユーザーがClaude Codeを起動]
         ↓
┌─────────────────────────────────┐
│ Claude Code起動                  │
└─────────────────────────────────┘
         ↓
┌─────────────────────────────────┐
│ .claude/config.json 読み込み    │
│ mcpServersセクションを検出       │
└─────────────────────────────────┘
         ↓
┌─────────────────────────────────┐
│ MCPサーバー自動起動              │
│ $ node .../dist/index.js        │
│ (stdio経由で通信、ネットワーク不要)│
└─────────────────────────────────┘
         ↓
┌─────────────────────────────────┐
│ MCPサーバー: 初期化処理          │
│ - DocumentManager初期化          │
│ - ConfigManager初期化            │
└─────────────────────────────────┘
         ↓
┌─────────────────────────────────┐
│ ★全ドキュメントをメモリに読み込み│
│ - .claude/docs/*.md を全て読み込み│
│ - Map<docId, Document> に格納    │
│ - 1,000件で約10MB使用            │
└─────────────────────────────────┘
         ↓
┌─────────────────────────────────┐
│ プロジェクトコンテキスト構築      │
│ - 日付別インデックス作成          │
│ - タグ別インデックス作成          │
│ - ファイル別インデックス作成      │
└─────────────────────────────────┘
         ↓
┌─────────────────────────────────┐
│ ★整合性チェック実行              │
│ - 監査ログから未完了操作を検出    │
│ - 破損ドキュメントの検出          │
│ - メタデータ検証                  │
│ - 必要に応じて自動リカバリ        │
└─────────────────────────────────┘
         ↓
┌─────────────────────────────────┐
│ ★ファイルシステム監視開始         │
│ - .claude/docs/ を監視            │
│ - 他インスタンスの変更を検知      │
│ - 新規ファイル自動読み込み        │
└─────────────────────────────────┘
         ↓
┌─────────────────────────────────┐
│ 類似ドキュメント検出（メモリ内）  │
│ "5組の類似ドキュメントを検出"     │
└─────────────────────────────────┘
         ↓
┌─────────────────────────────────┐
│ メモリ使用量をログ出力            │
│ "Loaded 1,234 documents (15MB)"  │
└─────────────────────────────────┘
         ↓
   [Claude Code 使用可能]
```

**重要:**

- MCPサーバーは Claude Code 終了まで動作継続
- `/clear` してもメモリは保持される
- 全ドキュメントがメモリに常駐し、超高速検索が可能
- ファイルシステム監視により複数インスタンスでの同時作業をサポート

#### 1.2.3 実装記録フロー

```
[ユーザーがClaude Codeでコーディング]
         ↓
┌──────────────────────────────────────┐
│ Claude AI が Edit/Write ツール使用    │
└──────────────────────────────────────┘
         ↓
┌──────────────────────────────────────┐
│ after-tool-use-hook トリガー          │
│ (ツール使用後に自動実行)               │
└──────────────────────────────────────┘
         ↓
┌──────────────────────────────────────┐
│ Hook Script が MCP ツール呼び出し     │
│ Tool: record_implementation           │
└──────────────────────────────────────┘
         ↓
┌──────────────────────────────────────┐
│ MCP Server: DocumentManager          │
│ 1. 変更ファイルの検出                 │
│ 2. 実装内容の抽出                     │
│ 3. メタデータ生成                     │
└──────────────────────────────────────┘
         ↓
┌──────────────────────────────────────┐
│ ★機密情報検出・マスキング             │
│ SensitiveDataDetector:               │
│ - API_KEY, SECRET等を検出            │
│ - [REDACTED]に自動置換               │
│ - ユーザーに警告表示                  │
└──────────────────────────────────────┘
         ↓
┌──────────────────────────────────────┐
│ Summarizer: 要約生成                  │
│ - Ollama使用 OR                       │
│ - キーワード抽出（fallback）           │
└──────────────────────────────────────┘
         ↓
┌──────────────────────────────────────┐
│ ドキュメント保存（トランザクション）   │
│ 1. Markdownファイル作成               │
│ 2. YAMLフロントマター付与             │
│ 3. .claude/docs/ へ保存              │
│ 4. 成功を監査ログに記録               │
└──────────────────────────────────────┘
         ↓
┌──────────────────────────────────────┐
│ ★メモリキャッシュに即座に追加         │
│ - documentCache.set(docId, doc)      │
│ - プロジェクトインデックス更新        │
│ - 次のプロンプトから即座に検索可能    │
└──────────────────────────────────────┘
         ↓
┌──────────────────────────────────────┐
│ メモリ内で類似度チェック（超高速）     │
│ - 全キャッシュドキュメントと比較      │
│ - ファイル重複率 + タグ一致で判定     │
│ - レスポンス時間: 数ミリ秒           │
└──────────────────────────────────────┘
         ↓
     類似度 >= 0.9 ?
         ↓
    Yes  │  No
         ↓   └─→ [完了]
┌──────────────────────────────────────┐
│ Claude AIに統合提案                   │
│ "⚠️ 類似ドキュメント検出:             │
│  • JWT認証の基本実装 (類似度92%)      │
│  これらを統合しますか？"              │
└──────────────────────────────────────┘
         ↓
      [完了]
```

**注:** Vectra（ベクトルDB）は補助的に使用。メモリ内検索がメイン。

#### 1.2.4 関連ドキュメント検索フロー

```
[ユーザーがプロンプト送信]
         ↓
┌──────────────────────────────────────┐
│ user-prompt-submit-hook トリガー      │
│ (プロンプト送信時に自動実行)           │
└──────────────────────────────────────┘
         ↓
┌──────────────────────────────────────┐
│ Hook がプロンプト内容を取得           │
└──────────────────────────────────────┘
         ↓
┌──────────────────────────────────────┐
│ MCP Tool: search_related_docs         │
│ パラメータ: prompt内容                 │
└──────────────────────────────────────┘
         ↓
┌──────────────────────────────────────┐
│ ★メモリ内で超高速検索                 │
│ 1. 最近の5件を取得（日付インデックス）│
│ 2. キーワードマッチング               │
│ 3. タグ一致でフィルタリング           │
│ 4. ファイル名マッチング               │
│ 5. レスポンス: 数ミリ秒               │
└──────────────────────────────────────┘
         ↓
┌──────────────────────────────────────┐
│ 関連ドキュメントをフォーマット         │
│ - 最近の実装（最新5件）               │
│ - 関連する過去の実装（上位3件）        │
└──────────────────────────────────────┘
         ↓
┌──────────────────────────────────────┐
│ Hook がプロンプトに追加               │
│ 拡張プロンプト → Claude AI           │
│                                      │
│ "## 最近の実装                       │
│  • JWT認証 (src/auth/login.ts)       │
│  • API設計 (src/api/routes.ts)       │
│                                      │
│  ## 関連する過去の実装                │
│  • JWT認証システムの詳細..."         │
└──────────────────────────────────────┘
         ↓
   [Claude が実装を開始]
```

**重要:**

- `/clear` 後でもメモリは保持されるため、過去の実装を参照可能
- セッション跨ぎで完全な情報保持
- 作業A→作業B→作業Aの続き、でも作業Aを記憶

#### 1.2.5 ドキュメント統合フロー

```
[ユーザーまたはClaude AIがマージを指示]
"ドキュメントを整理して"
         ↓
┌──────────────────────────────────────┐
│ MCP Tool: merge_similar_docs         │
│ パラメータ: threshold (デフォルト0.85)│
└──────────────────────────────────────┘
         ↓
┌──────────────────────────────────────┐
│ DocumentMerger: 類似ドキュメント検出  │
│ 1. ★メモリキャッシュから全取得（超高速）│
│ 2. ペアごとに類似度計算（メモリ内）    │
│ 3. 関連ファイル重複率計算             │
│ 4. レスポンス: 10ms以内（1,000件）    │
└──────────────────────────────────────┘
         ↓
┌──────────────────────────────────────┐
│ 統合候補グループ化                    │
│ Group 1: [doc1, doc2] (JWT認証関連)  │
│ Group 2: [doc3, doc4, doc5] (API設計)│
└──────────────────────────────────────┘
         ↓
┌──────────────────────────────────────┐
│ 各グループをAI統合                    │
│ Ollama: 複数ドキュメントを読み込み    │
│ - 重複情報を統合                      │
│ - 時系列を保持                        │
│ - 統合ドキュメント生成                │
└──────────────────────────────────────┘
         ↓
┌──────────────────────────────────────┐
│ 統合ドキュメント保存                  │
│ - 新しいUUID生成                      │
│ - merged_from にIDリスト記録          │
│ - authorsを統合                       │
└──────────────────────────────────────┘
         ↓
┌──────────────────────────────────────┐
│ 元のドキュメントをアーカイブ          │
│ .claude/docs/ → .archive/ へ移動     │
└──────────────────────────────────────┘
         ↓
┌──────────────────────────────────────┐
│ ★メモリキャッシュ更新                 │
│ - 元のドキュメント削除                │
│   documentCache.delete(doc1.id)      │
│   documentCache.delete(doc2.id)      │
│ - 統合ドキュメント追加                │
│   documentCache.set(merged.id, ...)  │
│ - インデックス更新                    │
└──────────────────────────────────────┘
         ↓
┌──────────────────────────────────────┐
│ 監査ログ記録                          │
│ - 操作: merge_documents              │
│ - 詳細: 類似度、ファイル重複率        │
└──────────────────────────────────────┘
         ↓
┌──────────────────────────────────────┐
│ 統合結果を返す                        │
│ "3組のドキュメントを統合しました"     │
└──────────────────────────────────────┘
         ↓
      [完了]
```

---

## 2. メモリキャッシュアーキテクチャ

### 2.1 メモリキャッシュ構造

```typescript
class MCPServer {
  // 全ドキュメントのメモリキャッシュ
  private documentCache: Map<string, Document> = new Map();

  // 高速検索用インデックス
  private projectContext: {
    byDate: Map<string, Document[]>; // 日付別
    byTag: Map<string, Document[]>; // タグ別
    byFile: Map<string, Document[]>; // ファイル別
    allDocs: Document[]; // 全体リスト
  };
}
```

### 2.2 メモリ使用量の試算

| ドキュメント数 | メモリ使用量 | 検索速度 | 推奨環境           |
| -------------- | ------------ | -------- | ------------------ |
| 100件          | 1MB          | <1ms     | 通常               |
| 1,000件        | 10MB         | <10ms    | 通常               |
| 10,000件       | 100MB        | <100ms   | 大規模プロジェクト |
| 100,000件      | 1GB          | <1s      | 超大規模（警告）   |

### 2.3 `/clear` とメモリの関係

```
Claude Code プロセス
├── Claude AI セッション
│   └── /clear → ここだけクリア
│
└── MCPサーバー（Node.jsプロセス）
    └── documentCache (Map)
        └── /clear しても保持される
        └── Claude Code終了まで永続
```

**重要:** MCPサーバーのメモリはClaude AIのセッションとは独立して存在します。
