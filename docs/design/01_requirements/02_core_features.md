# 要件定義書 - コア機能

## ドキュメント情報

| 項目           | 内容                |
| -------------- | ------------------- |
| プロジェクト名 | claude-dev-recorder |
| バージョン     | 1.0.0               |
| 作成日         | 2025-11-19          |
| 最終更新日     | 2025-11-19          |
| ステータス     | Draft               |

---

## 1. 初回セットアップ機能（FR-001）

### 1.1 自動インストール

- **優先度**: 必須
- **説明**: `npm install claude-dev-recorder` 実行時に自動的に環境をセットアップ
- **詳細**:
  - `.claude/` ディレクトリの存在確認
  - `.claude/config.json` への MCP サーバー設定追加
  - `.claude/hooks/` へのフックスクリプト配置
  - `.claude/docs/` ディレクトリの初期化
  - ベクトルインデックスの初期化

### 1.2 セットアップ検証

- **優先度**: 必須
- **説明**: セットアップ完了後に設定の正当性を検証
- **詳細**:
  - 必要なディレクトリの存在確認
  - config.jsonの構文チェック
  - フックスクリプトの実行権限確認

---

## 2. 実装履歴記録機能（FR-002）

### 2.1 自動ドキュメント生成

- **優先度**: 必須
- **説明**: Claude Codeでの実装完了時に自動的にドキュメントを生成
- **詳細**:
  - ツール使用履歴（Edit, Write, Bash等）の検知
  - 変更されたファイルの抽出
  - 実装内容の要約生成
  - メタデータ（日時、関連ファイル、タグ）の付与
  - `.claude/docs/` への保存

### 2.2 ドキュメント形式

- **優先度**: 必須
- **説明**: 一貫性のあるドキュメント形式で保存
- **詳細**:
  - Markdown形式
  - YAMLフロントマター（メタデータ）
  - ファイル名: `YYYY-MM-DD_UUID_summary.md`
  - 必須フィールド: id, created, tags, related_files, prompt_hash

### 2.3 ベクトルインデックス更新

- **優先度**: 必須
- **説明**: 生成したドキュメントをベクトルデータベースに登録
- **詳細**:
  - ドキュメント内容の埋め込みベクトル化
  - ローカルベクトルストアへの保存
  - インデックスの自動更新

---

## 3. 関連ドキュメント検索機能（FR-003）

### 3.1 プロンプト解析

- **優先度**: 必須
- **説明**: ユーザーのプロンプトから意図を解析
- **詳細**:
  - プロンプト内容の埋め込みベクトル化
  - 実装タスクか質問かの判定
  - キーワード抽出

### 3.2 類似ドキュメント検索

- **優先度**: 必須
- **説明**: プロンプトに関連する過去の実装履歴を検索
- **詳細**:
  - ベクトル類似度検索（上位3件）
  - 関連度スコアの算出
  - 関連度が低い場合は検索結果を返さない（閾値: 0.7）

### 3.3 ドキュメント要約

- **優先度**: 必須
- **説明**: 検索したドキュメントを要約してコンテキストに注入
- **詳細**:
  - AIによる要約（元の30%程度に圧縮）
  - キーポイントの抽出
  - 関連ファイルパスの明示

---

## 4. ドキュメント管理機能（FR-004）

### 4.1 ドキュメント整理

- **優先度**: 推奨
- **説明**: 古いドキュメントや類似ドキュメントの整理
- **詳細**:
  - MCPツール: `merge_similar_docs` で類似ドキュメントを統合
  - 30日以上参照されていないドキュメントのアーカイブ
  - アーカイブディレクトリ: `.claude/docs/.archive/`
  - Claude Code起動時に類似ドキュメント検出・通知

### 4.2 ドキュメント検索UI（MCP Tool）

- **優先度**: 推奨
- **説明**: Claude Codeから明示的にドキュメントを検索できるツール
- **詳細**:
  - MCPツール: `search_implementation_history`
  - パラメータ: keyword, tags, date_range
  - 検索結果のフォーマット表示

### 4.3 ドキュメント削除

- **優先度**: 推奨
- **説明**: 不要なドキュメントを削除するツール
- **詳細**:
  - MCPツール: `delete_implementation_doc`
  - ベクトルインデックスからも削除
  - 削除履歴の記録

---

## 5. コンフリクト回避機能（FR-005）

### 5.1 常に新規ドキュメント作成

- **優先度**: 必須
- **説明**: 実装のたびに新しいドキュメントファイルを作成（既存ドキュメントを更新しない）
- **詳細**:
  - UUID v4 + タイムスタンプでファイル名の一意性を保証
  - 複数人が同時に作業してもファイル名が衝突しない
  - Gitコンフリクトが原理的に発生しない設計

### 5.2 類似ドキュメント検出

- **優先度**: 必須
- **説明**: 類似したトピックのドキュメントを自動検出
- **詳細**:
  - ベクトル類似度検索（閾値: 0.85以上）
  - 関連ファイルの重複率チェック（50%以上）
  - Claude Code起動時に類似ドキュメント数を通知

### 5.3 ドキュメント統合機能

- **優先度**: 必須
- **説明**: 類似ドキュメントを統合して整理
- **詳細**:
  - MCPツール: `merge_similar_docs` を提供
  - AIによる複数ドキュメントの統合
  - 統合後、元のドキュメントは `.archive/` に移動
  - 統合メタデータ（`merged_from`）を記録

### 5.4 統合ドキュメント形式

- **優先度**: 必須
- **説明**: 統合されたドキュメントの形式定義
- **詳細**:
  - メタデータに `merged_from` フィールド（統合元ID配列）
  - 複数の `authors` を記録
  - 統合タイムスタンプを記録
  - 時系列を保持した統合本文

### 5.5 作成者情報の記録

- **優先度**: 推奨
- **説明**: ドキュメント作成者を識別
- **詳細**:
  - Git設定から `user.email` を取得
  - メタデータに author フィールドを追加
  - 統合時は複数の authors を配列で保持
  - チーム開発での責任追跡

---

## 次のセクション

詳細について以下のファイルを参照してください：

- [プロジェクト概要 (01_overview.md)](./01_overview.md)
- [応用機能 (03_advanced_features.md)](./03_advanced_features.md) - 品質管理・変更履歴・メモリキャッシュ機能
- [信頼性機能 (04_reliability_features.md)](./04_reliability_features.md) - 並行実行・整合性・機密保護機能
- [受け入れ基準と成功基準 (05_acceptance_criteria.md)](./05_acceptance_criteria.md)
