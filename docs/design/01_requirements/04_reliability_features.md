# 要件定義書 - 信頼性機能

## ドキュメント情報

| 項目           | 内容                |
| -------------- | ------------------- |
| プロジェクト名 | claude-dev-recorder |
| バージョン     | 1.0.0               |
| 作成日         | 2025-11-19          |
| 最終更新日     | 2025-11-19          |
| ステータス     | Draft               |

---

## 1. 並行実行対策機能（FR-010）

### 1.1 ファイルシステム監視

- **優先度**: 必須
- **説明**: 他のClaude Codeインスタンスによるドキュメント変更を検知
- **詳細**:
  - Node.js `fs.watch()` で `.claude/docs/` を監視
  - 新しいファイルが追加されたら自動的にメモリに読み込み
  - ファイル更新を検知してメモリを同期
  - 複数インスタンスでの同時作業をサポート

### 1.2 定期的な同期チェック

- **優先度**: 必須
- **説明**: ファイルシステムとメモリの定期同期
- **詳細**:
  - 1分ごとにファイルシステムとメモリを比較
  - 新規ファイル検出時に自動読み込み
  - 削除されたファイルをメモリから削除
  - 同期状態をログに記録

### 1.3 Git操作後のリロード

- **優先度**: 推奨
- **説明**: Git pull/merge後に自動リロード
- **詳細**:
  - Git post-mergeフックを自動配置
  - マージ後にリロード通知ファイル作成
  - MCPサーバーが検知して全ドキュメント再読み込み
  - チーム開発での同期を保証

---

## 2. データ整合性保証機能（FR-011）

### 2.1 起動時整合性チェック

- **優先度**: 必須
- **説明**: MCPサーバー起動時にデータ整合性を検証
- **詳細**:
  - ファイルシステムとメタデータの整合性チェック
  - 監査ログから未完了操作を検出
  - 破損したドキュメントの検出
  - 自動リカバリまたはユーザーに通知

### 2.2 トランザクション的な操作

- **優先度**: 必須
- **説明**: ドキュメント操作の原子性を保証
- **詳細**:
  - ファイル保存 → メモリ追加 の順序を保証
  - エラー時のロールバック処理
  - 操作の完了を監査ログに記録
  - 中断された操作の検出と復旧

### 2.3 メタデータ検証

- **優先度**: 必須
- **説明**: メタデータの妥当性を検証
- **詳細**:
  - 必須フィールドの存在チェック
  - UUID形式の検証
  - 日付フォーマットの検証
  - 不正なメタデータを持つドキュメントの検出

### 2.4 リカバリ機能

- **優先度**: 必須
- **説明**: エラーや不整合からの自動復旧
- **詳細**:
  - メモリキャッシュの再構築
  - 破損ドキュメントのスキップ
  - バックアップからの復元（オプション）
  - リカバリ操作の監査ログ記録

---

## 3. 機密情報保護機能（FR-012）

### 3.1 機密情報の自動検出

- **優先度**: 必須
- **説明**: ドキュメント作成時に機密情報を自動検出
- **詳細**:
  - パターンマッチング（API_KEY, SECRET, PASSWORD等）
  - APIキー形式の検出（sk-xxx, ghp-xxx等）
  - 長いランダム文字列の検出
  - 環境変数値の検出

### 3.2 自動除外・マスキング

- **優先度**: 必須
- **説明**: 検出した機密情報を自動的にマスキング
- **詳細**:
  - 検出箇所を `[REDACTED]` に置換
  - ユーザーに警告通知
  - マスキング前の内容は保存しない
  - 監査ログに検出履歴を記録

### 3.3 機密情報検出ルールのカスタマイズ

- **優先度**: 推奨
- **説明**: プロジェクト固有の機密パターンを追加
- **詳細**:
  - 設定ファイルでカスタムパターン定義
  - 正規表現でのパターン追加
  - ホワイトリスト機能（除外パターン）
  - パターンマッチのテスト機能

### 3.4 .gitignore 連携

- **優先度**: 推奨
- **説明**: .gitignoreされたファイル内容を除外
- **詳細**:
  - .env, credentials.json等のファイル検出
  - .gitignoreパターンに一致するファイルをスキップ
  - 警告メッセージ表示
  - 手動で含める場合は明示的な承認が必要

---

## 4. アンインストール保護機能（FR-013）

### 4.1 ドキュメント保持

- **優先度**: 必須
- **説明**: アンインストール時にドキュメントを保持
- **詳細**:
  - `.claude/docs/` ディレクトリは削除しない
  - ユーザーに明示的に通知
  - 設定ファイルのみクリーンアップ
  - フックスクリプトは削除

### 4.2 設定のクリーンアップ

- **優先度**: 必須
- **説明**: アンインストール時に設定を適切にクリーンアップ
- **詳細**:
  - `.claude/config.json` から mcpServers 設定を削除
  - `.claude/hooks/` からフックスクリプトを削除
  - `.claude/recorder.config.json` を削除
  - バックアップを作成してから削除

### 4.3 アンインストール確認

- **優先度**: 推奨
- **説明**: アンインストール時にユーザーに確認
- **詳細**:
  - ドキュメント数を表示
  - 保持されることを明示
  - 完全削除したい場合の手順を案内
  - preuninstallスクリプトで実装

### 4.4 ドキュメントエクスポート推奨

- **優先度**: 推奨
- **説明**: アンインストール前にエクスポートを推奨
- **詳細**:
  - バックアップ作成を提案
  - エクスポートコマンドを表示
  - エクスポート先パスを案内
  - エクスポート完了を確認

---

## 次のセクション

詳細について以下のファイルを参照してください：

- [プロジェクト概要 (01_overview.md)](./01_overview.md)
- [コア機能 (02_core_features.md)](./02_core_features.md)
- [応用機能 (03_advanced_features.md)](./03_advanced_features.md) - 品質管理・変更履歴・メモリキャッシュ機能
- [受け入れ基準と成功基準 (05_acceptance_criteria.md)](./05_acceptance_criteria.md)
