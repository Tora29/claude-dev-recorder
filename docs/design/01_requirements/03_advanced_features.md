# 要件定義書 - 応用機能

## ドキュメント情報

| 項目           | 内容                |
| -------------- | ------------------- |
| プロジェクト名 | claude-dev-recorder |
| バージョン     | 1.0.0               |
| 作成日         | 2025-11-19          |
| 最終更新日     | 2025-11-19          |
| ステータス     | Draft               |

---

## 1. ドキュメント品質管理機能（FR-006）

### 1.1 統合前レビュー・承認

- **優先度**: 必須
- **説明**: ドキュメント統合前にプレビューと承認フローを提供
- **詳細**:
  - MCPツール: `preview_merge` でプレビュー生成
  - 統合対象のグループ化表示
  - 統合後の内容プレビュー
  - ユーザーまたはClaude AIが承認判断
  - 承認後のみ実際の統合を実行

### 1.2 AI品質レビュー

- **優先度**: 推奨
- **説明**: AIによるドキュメント品質の自動チェック
- **詳細**:
  - 内容の妥当性チェック
  - 矛盾検出（同じファイルに異なる実装記述など）
  - 古い情報の検出（90日以上更新なし）
  - 非推奨API使用の検出
  - 品質スコアの算出（0.0～1.0）

### 1.3 定期最適化

- **優先度**: 推奨
- **説明**: 定期的にドキュメント全体を最適化
- **詳細**:
  - Claude Code起動時に品質チェック実行
  - 週次での自動チェック（オプション）
  - 重複コンテンツの検出
  - 情報の鮮度チェック
  - 推奨アクションの提示（統合推奨、更新推奨、削除推奨）

### 1.4 ドキュメントスコアリング

- **優先度**: 推奨
- **説明**: 各ドキュメントに品質指標を付与
- **詳細**:
  - 鮮度スコア（最終更新日からの経過日数）
  - 完全性スコア（必要情報の充足度）
  - 参照回数（過去の検索ヒット回数）
  - 総合品質スコア（上記の加重平均）
  - 低スコアドキュメントの自動検出

---

## 2. 変更履歴・トレーサビリティ機能（FR-007）

### 2.1 変更履歴の記録

- **優先度**: 必須
- **説明**: ドキュメントの全変更を詳細に記録
- **詳細**:
  - メタデータの `change_log` フィールドに記録
  - 変更日時、操作者、操作内容、理由を記録
  - 統合時は統合理由（類似度スコア、ファイル重複率）も記録
  - 手動編集時は変更内容の要約を記録

### 2.2 監査ログ

- **優先度**: 必須
- **説明**: システム全体の操作ログを記録
- **詳細**:
  - ログファイル: `.claude/docs/.audit/audit.log`
  - JSON形式で記録
  - 記録内容: タイムスタンプ、操作、操作者、詳細、影響度
  - ドキュメント統合、削除、アーカイブの全記録
  - 定期的なログローテーション（1MB超過時）

### 2.3 ロールバック機能

- **優先度**: 推奨
- **説明**: ドキュメント統合を取り消す機能
- **詳細**:
  - MCPツール: `rollback_merge`
  - アーカイブから元のドキュメントを復元
  - 統合ドキュメントを削除
  - ベクトルインデックスを更新
  - ロールバック操作も監査ログに記録

### 2.4 変更履歴参照

- **優先度**: 推奨
- **説明**: ドキュメントの変更履歴を参照する機能
- **詳細**:
  - MCPツール: `get_document_history`
  - 時系列での変更一覧表示
  - 各変更の詳細情報表示
  - 変更前後の差分表示（オプション）

---

## 3. メモリキャッシュ管理機能（FR-008）

### 3.1 全ドキュメントのメモリ読み込み

- **優先度**: 必須
- **説明**: Claude Code起動時に全ドキュメントをMCPサーバーのメモリに読み込み
- **詳細**:
  - MCPサーバー初期化時に全ドキュメントをメモリに読み込み
  - ドキュメント本文、メタデータ、要約を含む
  - Map構造でIDをキーに高速アクセス
  - Claude Code終了までメモリに保持
  - 想定メモリ使用量: 1,000件で10MB、10,000件で100MB

### 3.2 リアルタイムメモリ更新

- **優先度**: 必須
- **説明**: ドキュメント作成・更新・削除時にメモリキャッシュを即座に更新
- **詳細**:
  - 新規ドキュメント作成: 即座にメモリに追加
  - ドキュメント統合: 元を削除、統合版を追加
  - ドキュメント削除: メモリからも削除
  - 次のプロンプトから即座に検索可能

### 3.3 メモリ内高速検索

- **優先度**: 必須
- **説明**: ディスクI/O不要のメモリ内検索で超高速応答
- **詳細**:
  - キーワード検索（サマリー、タグ、ファイル名）
  - ファイル重複率による類似度計算
  - タグ一致による関連性判定
  - レスポンス時間: 数ミリ秒
  - ベクトルデータベース（Vectra）は補助的に使用

### 3.4 プロジェクトコンテキストインデックス

- **優先度**: 必須
- **説明**: 高速検索のための複数インデックスを保持
- **詳細**:
  - 日付別インデックス（最近の実装を高速取得）
  - タグ別インデックス（関連トピック検索）
  - ファイル別インデックス（同じファイルの変更履歴）
  - メモリ更新時に自動的にインデックス更新

### 3.5 メモリ使用量監視

- **優先度**: 推奨
- **説明**: メモリ使用量を監視し、必要に応じて最適化
- **詳細**:
  - 1分ごとにメモリ使用量をチェック
  - 1GB超過時に警告ログ出力
  - 90日以上古いドキュメントをメモリから削除（オプション）
  - メモリ使用状況をログに記録

---

## 4. セッション跨ぎ情報保持機能（FR-009）

### 4.1 `/clear` 後の情報保持

- **優先度**: 必須
- **説明**: `/clear` でClaude AIの会話履歴がクリアされてもMCPサーバーのメモリは保持
- **詳細**:
  - MCPサーバーはClaude Code終了まで動作継続
  - `/clear` してもドキュメントメモリは消えない
  - 次のプロンプトで過去の実装情報を提供可能
  - セッション跨ぎで完全な情報保持

### 4.2 プロンプトへの自動コンテキスト注入

- **優先度**: 必須
- **説明**: プロンプト送信時に自動的に関連コンテキストを注入
- **詳細**:
  - 最近の5件の実装を自動注入（約250トークン）
  - ベクトル・キーワード検索で関連ドキュメント3件（約600トークン）
  - 合計: 約850トークン（コンテキストの1%未満）
  - `/clear` の有無に関わらず常に同じ動作

### 4.3 作業順序非依存の記憶

- **優先度**: 必須
- **説明**: 作業A→作業B→作業Aの続き、でも作業Aを記憶
- **詳細**:
  - 全ドキュメントがメモリに常駐
  - プロンプト内容から関連ドキュメントを検索
  - 作業順序に関係なく過去の実装を参照可能
  - セッションを跨いでも全履歴を意識

### 4.4 即座の類似度検出

- **優先度**: 必須
- **説明**: ドキュメント作成直後にメモリ内で類似度チェック
- **詳細**:
  - 新規ドキュメント作成時、メモリ内の全ドキュメントと比較
  - ファイル重複率、タグ一致、キーワード類似度で判定
  - 類似度0.9以上で統合提案を即座に表示
  - ディスクI/O不要で超高速（数ミリ秒）

---

## 次のセクション

詳細について以下のファイルを参照してください：

- [プロジェクト概要 (01_overview.md)](./01_overview.md)
- [コア機能 (02_core_features.md)](./02_core_features.md)
- [信頼性機能 (04_reliability_features.md)](./04_reliability_features.md) - 並行実行・整合性・機密保護機能
- [受け入れ基準と成功基準 (05_acceptance_criteria.md)](./05_acceptance_criteria.md)
