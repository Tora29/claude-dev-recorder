# 要件定義書 - 受け入れ基準と成功基準

## ドキュメント情報

| 項目           | 内容                |
| -------------- | ------------------- |
| プロジェクト名 | claude-dev-recorder |
| バージョン     | 1.0.0               |
| 作成日         | 2025-11-19          |
| 最終更新日     | 2025-11-19          |
| ステータス     | Draft               |

---

## 1. 非機能要件

### 1.1 性能要件（NFR-001）

#### 1.1.1 レスポンス時間

- プロンプト送信からドキュメント検索完了まで: 100ms以内（メモリ内検索）
- ドキュメント生成完了まで: 5秒以内
- メモリ内検索: 数ミリ秒
- 類似度チェック: 10ms以内（1,000ドキュメント）

#### 1.1.2 リソース使用量

- メモリ使用量: 1,000ドキュメントで10MB、10,000ドキュメントで100MB
- ディスク使用量: 1,000ドキュメントで100MB以下
- CPUスパイク: セットアップ時とドキュメント生成時のみ許容
- メモリ上限: 1GB（警告）、2GB（クリーンアップ実行）

### 1.2 可用性要件（NFR-002）

#### 1.2.1 エラーハンドリング

- Ollamaが起動していない場合: キーワードベースのfallback検索に切り替え
- メモリ不足時: 古いドキュメントをメモリから削除、ディスクから読み込み
- 要約生成失敗時: 元のドキュメントの冒頭500文字を使用
- メモリ読み込み失敗時: ディスクから都度読み込みモードに切り替え

#### 1.2.2 フォールバック機能

- AI要約が使えない場合でも基本機能は動作
- ネットワーク不要（完全ローカル動作）
- 外部サービス依存なし

### 1.3 保守性要件（NFR-003）

#### 1.3.1 ログ出力

- デバッグモード: 環境変数 `DEBUG=claude-dev-recorder:*`
- エラーログ: `.claude/docs/.logs/error.log`
- 動作ログ: 標準出力（開発時のみ）

#### 1.3.2 設定のカスタマイズ

- 設定ファイル: `.claude/recorder.config.json`
- カスタマイズ可能項目:
  - 要約の最大文字数
  - 検索結果の上限件数
  - アーカイブまでの日数
  - 使用する埋め込みモデル

### 1.4 セキュリティ要件（NFR-004）

#### 1.4.1 データプライバシー

- 全データはローカルに保存
- 外部へのデータ送信なし（Ollama使用時）
- `.gitignore` への `.claude/docs/.index/` 自動追加（オプション）

#### 1.4.2 実行権限

- フックスクリプトの実行権限を適切に設定
- 任意のコマンド実行を許可しない
- サンドボックス内での動作

### 1.5 互換性要件（NFR-005）

#### 1.5.1 対応環境

- Node.js: v18以降
- OS: macOS, Linux, Windows (WSL)
- Claude Code: 最新版

#### 1.5.2 依存パッケージ

- 最小限の依存関係
- セキュリティ脆弱性のないパッケージのみ使用
- 定期的な依存パッケージの更新

---

## 2. 制約事項

### 2.1 技術的制約

1. **Claude Code依存**: Claude Codeがインストールされていることが前提
2. **MCP対応**: Claude CodeがMCPプロトコルをサポートしている必要がある
3. **MCPサーバー**:
   - Claude Codeが自動的にMCPサーバー（Node.jsプロセス）を起動・管理
   - ユーザーが手動でサーバーを立てる必要はなし
   - ネットワークポート不要（stdio通信）
   - Webサーバーではなく、ローカルプロセス
4. **ファイルシステム**: `.claude/` ディレクトリへの読み書き権限が必要

### 2.2 運用上の制約

1. **初回起動**: npm install後、Claude Codeの再起動が必要
2. **AI要約**: Ollama使用時はOllamaのインストールと起動が必要（オプション）
3. **ディスク容量**: ドキュメント蓄積によりディスク容量を消費

### 2.3 ビジネス的制約

1. **無料提供**: 完全無料で使用可能（外部APIの課金なし）
2. **オープンソース**: MITライセンスでの公開
3. **npmパッケージ**: npm公式レジストリでの配布

---

## 3. ユーザーストーリー

### 3.1 US-001: 初回インストール

```
As a 開発者
I want パッケージをインストールするだけで機能が有効になる
So that 複雑な設定作業をせずにすぐに使い始められる

受け入れ基準:
- npm install claude-dev-recorder の実行のみで完了
- Claude Code再起動後、自動的にドキュメント記録が開始される
- エラーが発生した場合は分かりやすいメッセージが表示される
```

### 3.2 US-002: 自動ドキュメント生成

```
As a 開発者
I want 実装完了時に自動的にドキュメントが生成される
So that 手動でドキュメントを書く手間がなくなる

受け入れ基準:
- Claude Codeでコードを書いた後、自動的に.claude/docs/に保存される
- ドキュメントには実装内容の要約が含まれる
- 変更したファイルのパスが記録される
```

### 3.3 US-003: 過去実装の自動参照

```
As a 開発者
I want 新しいタスクを依頼した時に関連する過去の実装が自動で参照される
So that 同じことを何度も説明しなくて済む

受け入れ基準:
- プロンプト送信時、関連する過去実装が自動検索される
- 検索結果が要約されてコンテキストに含まれる
- 関連度が低い場合は余計な情報が含まれない
```

### 3.4 US-004: チーム開発での知識共有

```
As a チームメンバー
I want 他のメンバーの実装履歴を参照できる
So that チーム全体の知識を活用できる

受け入れ基準:
- Gitでドキュメントを共有できる
- 複数人が同時に作業してもコンフリクトしない
- 誰が実装したかを識別できる
```

### 3.5 US-005: ドキュメント管理

```
As a 開発者
I want 古いドキュメントが自動的に整理される
So that 常に関連性の高い情報のみが保持される

受け入れ基準:
- 類似ドキュメントが自動統合される
- 古いドキュメントがアーカイブされる
- 必要に応じて手動で削除できる
```

### 3.6 US-006: 統合前のレビュー

```
As a 開発者
I want ドキュメント統合前に内容を確認できる
So that 意図しない統合や情報損失を防げる

受け入れ基準:
- 統合前にプレビューが表示される
- 統合対象のドキュメント一覧が確認できる
- 統合後の内容が事前に確認できる
- 承認または却下を選択できる
- 却下した場合は統合が実行されない
```

### 3.7 US-007: ドキュメント品質の維持

```
As a 開発者
I want ドキュメントの品質が自動的にチェックされる
So that 常に正確で最新の情報を保持できる

受け入れ基準:
- Claude Code起動時に品質チェックが実行される
- 古い情報や矛盾が検出される
- 推奨アクション（更新、統合、削除）が提示される
- 品質スコアが各ドキュメントに表示される
```

### 3.8 US-008: 変更履歴の追跡

```
As a チームリーダー
I want ドキュメントの変更履歴を追跡できる
So that 誰が何をいつ変更したかを把握できる

受け入れ基準:
- 各ドキュメントの変更履歴が参照できる
- 統合、編集、削除の全操作が記録される
- 監査ログで全体の操作履歴が確認できる
- 必要に応じて統合をロールバックできる
```

### 3.9 US-009: セッション跨ぎの情報保持

```
As a 開発者
I want /clearでセッションをリセットしても過去の実装情報を保持できる
So that 会話を整理しながらも実装の文脈を失わない

受け入れ基準:
- /clear 実行後も過去の実装情報が参照可能
- 作業A→作業B→作業Aの続き、という順序でも作業Aを記憶
- MCPサーバーのメモリに全ドキュメントが保持される
- Claude Code再起動しない限り情報は永続
```

### 3.10 US-010: 新規ドキュメントの即座利用

```
As a 開発者
I want 今作ったドキュメントを次のプロンプトですぐに参照できる
So that 連続した作業がスムーズに進む

受け入れ基準:
- ドキュメント作成直後にメモリに追加される
- 次のプロンプトから即座に検索可能
- ディスク再読み込み不要
- レスポンス時間は数ミリ秒
```

---

## 4. 成功基準

### 4.1 定量的指標

1. **インストール成功率**: 95%以上
2. **ドキュメント生成成功率**: 90%以上
3. **検索精度**: 関連度0.7以上のドキュメントを80%以上の確率で発見
4. **レスポンス時間**: プロンプト送信から2秒以内に検索完了
5. **コンテキスト削減率**: 要約により元ドキュメントの30%以下に圧縮
6. **統合精度**: 統合後のドキュメント品質スコア0.8以上
7. **監査ログ完全性**: 全操作の100%を記録

### 4.2 定性的指標

1. **ユーザー満足度**: GitHub Starが100以上
2. **エラー報告**: 致命的なバグ報告が月間5件以下
3. **ドキュメント品質**: 生成されたドキュメントが実用的で理解しやすい
4. **保守性**: 新機能追加が容易な設計
5. **トレーサビリティ**: 変更履歴が明確で追跡可能
6. **ユーザーレビュー**: 統合前レビューにより意図しない統合が発生しない

---

## 5. スコープ外

以下の機能は本バージョンでは実装しない：

1. **GUI管理画面**: CLIツールのみ提供
2. **クラウド同期**: ローカルストレージのみ
3. **リアルタイム要約**: 実装完了後のバッチ処理のみ
4. **他エディタ対応**: Claude Code専用
5. **多言語ドキュメント**: 日本語・英語のみ対応
6. **ドキュメントのバージョン管理**: 作成日ベースのスナップショットのみ

---

## 6. リスクと対策

### リスク管理表

| ID    | リスク                                 | 影響度 | 発生確率 | 対策                                               |
| ----- | -------------------------------------- | ------ | -------- | -------------------------------------------------- |
| R-001 | Claude Code API変更により動作不能      | 高     | 中       | MCPの標準仕様に準拠、定期的な動作確認              |
| R-002 | ベクトル検索の精度が低い               | 中     | 中       | キーワードベースのfallback検索を実装               |
| R-003 | Ollama未インストール環境で動作しない   | 低     | 高       | AI不要のfallback機能を実装                         |
| R-004 | ドキュメントが大量に蓄積しディスク圧迫 | 中     | 高       | 自動アーカイブ機能、サイズ上限警告                 |
| R-005 | Gitコンフリクトが頻発                  | 低     | 低       | UUID + タイムスタンプ + 常に新規作成戦略           |
| R-006 | 要約精度が低く有用性が低い             | 中     | 中       | ユーザーフィードバック機能、要約設定のカスタマイズ |
| R-007 | 意図しない統合で情報損失               | 高     | 中       | プレビュー機能、承認フロー、ロールバック機能       |
| R-008 | 品質チェックの誤検知                   | 中     | 中       | スコア閾値の調整、手動レビュー機能                 |
| R-009 | 監査ログの肥大化                       | 低     | 高       | 定期的なログローテーション、圧縮保存               |
| R-010 | 変更履歴の不整合                       | 中     | 低       | 原子的操作、トランザクション管理                   |

---

## 7. 承認

| 役割                 | 氏名 | 承認日 | 署名 |
| -------------------- | ---- | ------ | ---- |
| プロジェクトオーナー | -    | -      | -    |
| 技術リード           | -    | -      | -    |
| QAリード             | -    | -      | -    |

---

## 8. 改訂履歴

| バージョン | 日付       | 変更内容 | 変更者 |
| ---------- | ---------- | -------- | ------ |
| 1.0.0      | 2025-11-19 | 初版作成 | -      |

---

## 関連ドキュメント

詳細について以下のファイルを参照してください：

- [プロジェクト概要 (01_overview.md)](./01_overview.md)
- [コア機能 (02_core_features.md)](./02_core_features.md)
- [応用機能 (03_advanced_features.md)](./03_advanced_features.md)
- [信頼性機能 (04_reliability_features.md)](./04_reliability_features.md)
